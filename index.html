<!DOCTYPE html>
<html>
<head>
<title>Defy: Audio Demake Tool for PICO-8</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
<link rel="stylesheet" href="defy.css">
</head>
<body>
	<h1 class="text-center display-4">Defy: Audio Demake Tool for PICO-8</h1>
	<div class="table mx-auto">
		<div class="table-row">
			<div class="table-cell">
				<div class="table-row">
					<div class="table-cell">
						<div id="FileDrop">
							<div  id="Text">Drop audio file here or click to choose file.</div>
							<input type="file" accept="audio">
						</div>
					</div>
					<div class="table-cell">
						<div class="table-row">
							<div class="table-cell">
								<form>
									<div class="form-group">
									<label for=formatSelection">Format</label>
									<select class="form-select custom-select" aria-label="format" id="formatSelection" >
										<option value="0">PCM</option>
										<option selected value="1">Defy Lossless</option>
										<option value="2">Defy Lossy 4-bit</option>
										<option value="3">Defy Lossy 2.6-bit</option>
										<option value="4">Defy Lossy 2-bit</option>
									</select>
									</div>
									<div class="form-group">
										<div class="form-check d-inline-block">
											<input class="form-check-input" type="checkbox" id="trim" checked>
											<label class="form-check-label" for="trim">Trim Leading Silence&nbsp;&nbsp;</label>
										</div>
										<div class="form-check d-inline-block">
											<input class="form-check-input" type="checkbox" id="antialiasing" checked>
											<label class="form-check-label " for="antialiasing">Apply Antialiasing Filter </label>
										</div>
									</div>
									<div id="defyOnly">	
										<div class="form-group">
										<label for=title">Title</label>
										<input type="text" class="form-control" id="title" value="Unknown" placeholder="Enter title bar text" maxLength="50" size="50"></input>
										</div>
										<div class="form-group">
											<label for=visualization">Preferred Visualizer</label>
											<select class="form-select custom-select" aria-label="visualization" id="visualization" >
												<option selected value="2">Cover Art</option>
												<option value="3">Oscilloscope</option>
												<option value="4">Bubble</option>
											</select>
											</div>
										<div class="form-group">
											<label for="cover">Optional Cover Art ( __gfx__ block)</label>
											<textarea class="form-control" id="cover" rows="5" cols=64></textarea>
										</div>
									</div> 
									<button class="btn btn-info d-none" type="button" value="Generate" id="generateButton"><span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" ></span> Generate
									</button>
								  </form>
							</div>	
						</div>	
					</div>
				</div>
			</div>
		</div>	
		<div class="table-row">
			<div class="table-cell">
				<div class="table-row"><div class="table-cell"><div>Use this tool to format audio files for the PICO-8 Defy Player or create raw unsigned 8-bit PCM data.</div></div></div>
				<div class="table-row"><div class="table-cell"><div>
					<ol>
						<li>Upload an audio file by clicking on the folder icon or dragging and dropping.</li>
						<li>Select output format</li>
							<ul>
								<li>PCM&mdash; raw unsigned 8-bit PCM, not playable in Defy, but may be useful elsewhere.</li>
								<li>Defy Lossless&mdash; best sounding audio for the Defy player and binary strings.</li>
								<li>Defy Lossy 4 Bit&mdash; acceptable audio for the Defy player and 2 to 1 compresssion ratio binary strings.</li>
								<li>Defy Lossy 2 Bit&mdash; 4 to 1 compresssion ratio binary strings suitable for intellible speech.</li>
							</ul>
						<li>The antialiasing filter improves audio downsampling for most browsers including Chrome.</li>	<li>To play Defy files:</li>
							<ol>
								<li>Start Pico-8.</li>
								<li>Enter <kbd>load #defy</kbd> at the command prompt.</li>
								<li>Then enter <kbd>run</kbd>.</li>
								<li>Drag and drop the defy file onto PIC0-8.</li>
							</ol>
						<li><a href="https://www.lexaloffle.com/bbs/?tid=46407&tkey=nP5Fh9LgqfwEXXBvJaGw">The Defy player also records binary audio strings for playback in your own carts.</a></li>	

					</ol>
				</div></div></div>
			</div>
		</div>			
	</div>

<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

<script type="text/javascript">
	var filename
	var file
	var spinner=document.querySelector("#generateButton span")
	var caption=document.querySelector("#generateButton text")
	if (!(window.File && window.FileReader && window.FileList && window.Blob))
	{
		document.querySelector("#FileDrop #Text").textContent ="Reading files not supported by this browser"
	} 
	else
	{
		const fileDrop = document.querySelector("#FileDrop")

		fileDrop.addEventListener("dragenter", () =>
			fileDrop.classList.add("Hover")
		)

		fileDrop.addEventListener("dragleave", () =>
			fileDrop.classList.remove("Hover")
		)

		fileDrop.addEventListener("drop", () =>
			fileDrop.classList.remove("Hover")
		)

		document.querySelector("#FileDrop input").addEventListener("change", (e) => 
		{
			const files = e.target.files
			if (files.length > 0) 
			{
				file = files[0]
				document.querySelector("#FileDrop #Text").textContent = file.name
				filename=file.name
				document.getElementById("title").value=file.name.split(".")[0]
				document.getElementById("generateButton").classList.remove("d-none")
			}
		})
		document.getElementById("formatSelection").addEventListener("change", (e) => 
		{
			var defyOnly=document.getElementById("defyOnly")
			if (e.target.value==="0"){defyOnly.classList.add("d-none")}
			else {defyOnly.classList.remove("d-none")}
		})
		document.getElementById("generateButton").addEventListener("click", (e) => 
		{
			spinner.classList.remove("d-none")
			setTimeout(()=>processFile(file,parseInt(document.getElementById("formatSelection").value)),0)
			
		})

	}
	// @luchak's antialiasing filter

	const halfBandCoefs=[
    0.31818338253226525,
    -0.10572409218627699,
    0.06303323470819239,
    -0.04459522956935277,
    0.034246199701349206,
    -0.027574724587867916,
    0.022887007878042098,
    -0.019392814851333928,
    0.01667277922156525,
    -0.014484717693976842,
    0.01267888376335044,
    -0.011160211790922761,
    0.00986139700760405,
    -0.00873637163826134,
    0.007749840633319523,
    -0.006883093647765105,
    0.006105497250026827,
    -0.005419266290437576,
    0.004800277381909891,
    -0.004240070555699461,
    0.0037358551293851516,
    -0.00328275034230777,
    0.002873832030999104,
    -0.0025032541130269037,
    0.0021682309610695696,
    -0.0018662433189703346,
    0.001595392324024004,
    -0.001352345693372876,
    0.003713684981166375
];

function zeroPad(samples, count) {
    const padded=new Float32Array(samples.length + count*2);
    for (let i=0; i < samples.length; i++) {
        padded[i + count] = samples[i];
    }
    return padded;
}

function halfBandFilter(samples, coefs) {
    const padAmount = 2*coefs.length + 1;
    const padded = zeroPad(samples, padAmount)
    const output = new Float32Array(Math.ceil(samples.length/2));
    for (let i=0; i < output.length; i++) {
        let base=padAmount + i*2;
        let filtered = 0.5*padded[base];
        for (let j=0; j < coefs.length; j++) {
            const offset = 2*j + 1;
            filtered += (padded[base-offset] + padded[base+offset])*coefs[j];
        }
        output[i]=filtered;
    }
    return output;
}

function processHalfBand(samples) {
    return halfBandFilter(samples, halfBandCoefs);
}


	function processFile(file, format)
	{
		//DVI ADPCM http://www.cs.columbia.edu/~hgs/audio/dvi/IMA_ADPCM.pdf adapted for 8-bit unsigned pcm
		var predictedSample = 0		// output of ADPCM predictor 
		var index = 0 				// index into stepsizeTable
		var step       // quantizer stepsize
		var adpcm=function(sample,bits)
		{
			const indexTable= [-1, -1, -1, -1, 2, 4, 6, 8, -1, -1, -1, -1, 2, 4, 6, 8]
			const stepTable =[7, 8, 9, 10, 11, 12, 13, 14, 16, 17, 19, 21, 23, 25, 28, 31, 34, 37, 41, 45, 50, 55, 60, 66, 73, 80, 88, 97, 107, 118,130, 143, 157, 173, 190, 209, 230, 253, 279, 307, 337, 371, 408, 449, 494, 544, 598, 658, 724, 796, 876, 963, 1060, 1166, 1282, 1411, 1552, 1707, 1878, 2066, 2272, 2499, 2749, 3024, 3327, 3660, 4026, 4428, 4871, 5358, 5894, 6484, 7132, 7845, 8630, 9493, 10442, 11487, 12635, 13899, 15289, 16818, 18500, 20350, 22385, 24623, 27086, 29794, 32767]
			const hi =32767
			const lo =-32768
			var delta = Math.trunc(sample*32768) - predictedSample
			if (delta >= 0) // set sign bit and find absolute value of difference 
			{
				var sign = 0 
			}
			else
			{
				var sign = 8 
				delta = -delta 
			}
			var qDelta=0
			var tempStep=step
			var magnitude=0
			var mask=2**(bits-2)  //4, 2, 1 === 4 bit, 3 bit, 2 bit
			for (i = 0; i < bits-1 ; i++ ) /* calculate magnitude and quantize delta */
			{
				if (delta>=tempStep)
				{ 
					magnitude=magnitude+mask //set bits according to mask 
					delta -= tempStep
					qDelta += tempStep 
				}
				tempStep=Math.trunc(tempStep/2)
				mask=mask/2
			}
			var newSample=sign/(2**(4-bits))+magnitude
			if (sign===8) {qDelta=-qDelta}
			predictedSample=predictedSample+qDelta
			if (predictedSample > hi){predictedSample = hi} /* check for overflow */
			else 
			{
				if (predictedSample < lo){predictedSample = lo}
			}	
			index =index+ indexTable[magnitude*(2**(4-bits)) +sign]
			if (index < 0){index = 0} /* check for index underflow */
			else
			{
				if (index >=stepTable.length)index = stepTable.length-1 /* check for index overflow */
			} 
			step = stepTable[index] /* find new quantizer stepsize */
			return newSample
		}
		var audioContext = new (window.AudioContext || window.webkitAudioContext)()
		var fileReader = new FileReader()
		fileReader.onload = function(e)
		{
			var antialias=document.getElementById("antialiasing").checked
			var source	
			audioContext.decodeAudioData(e.target.result).then(function(buffer)
			{
				if (!antialias)
				{
					var offlineAudioContext= new OfflineAudioContext(
					{
						numberOfChannels: 1,
						length: Math.ceil(5512.5 * buffer.duration),
						sampleRate: 11025, 
					})

					source = offlineAudioContext.createBufferSource()
					source.buffer = buffer
					source.detune.value = 1200  //Raise one octave.  11025/2 = 5512.5
					source.connect(offlineAudioContext.destination)
				}
				else
				{
					offlineAudioContext= new OfflineAudioContext(
					{
						numberOfChannels: 1,
						length: Math.ceil(22050 * buffer.duration),
						sampleRate: 22050, 
					})
					source = offlineAudioContext.createBufferSource()
					source.buffer = buffer
					source.connect(offlineAudioContext.destination)
				}	
				source.start()
				offlineAudioContext.startRendering().then(function(renderedBuffer)
				{
					var data=renderedBuffer.getChannelData(0)
					if (antialias)
					{
						data = processHalfBand(processHalfBand(data))
					}
					if (document.getElementById("trim").checked)
					{
						var i=1
						var firstValue=Math.trunc(data[0]*256)
						while (Math.trunc(data[i]*256)===firstValue)i++
						data=data.subarray(i-1)
					}
					switch (format)
					{
						case 0: //Unsigned 8 bit PCM
							data=new Uint8Array(data.map(value=>Math.trunc(value*128+128)))
							break
						case 1: //defy PCM
							data=new Uint8Array([...header(),...data.map(value=>Math.trunc(value*128+128))])
							break
						case 2: //defy 4 bit lossy
							var dataIn= data
							step =7
							var data=new Uint8Array(Array.from({ length: Math.floor(dataIn.length/2+.5)}, (_, i) =>
							{
								var value=adpcm(dataIn[i*2],4)*16  //hi nibble
								var j=i*2+1
								if (j<dataIn.length){value=value+adpcm(dataIn[j],4)}	//lo nibble
								return value
							}))
							data=new Uint8Array([...header(),...data])
							break
						case 3: //Defy 2.6 bit lossy
							var dataIn= data
							step =7
							var data=new Uint8Array(Array.from({ length: Math.floor(dataIn.length/3+.5)}, (_, i) =>
							{
								var value=adpcm(dataIn[i*3],3)*32  //hi 2 bit
								var j=i*3+1
								if (j<dataIn.length)
								{
									value=value+adpcm(dataIn[j],3)*4
									j++
									if (j<dataIn.length)
									{
										value=value+adpcm(dataIn[j],2,true)
										j++
									}
								}	
								return value
							}))
							data=new Uint8Array([...header(),...data])
							break	
						case 4: //Defy 2 bit lossy
							var dataIn= data
							step =251
							var data=new Uint8Array(Array.from({ length: Math.floor(dataIn.length/4+.5)}, (_, i) =>
							{
								var value=adpcm(dataIn[i*4],2)*64  //hi 2 bit
								var j=i*4+1
								if (j<dataIn.length)
								{
									value=value+adpcm(dataIn[j],2)*16
									j++
									if (j<dataIn.length)
									{
										value=value+adpcm(dataIn[j],2)*4
										j++
										if(j<dataIn.length)
										{
											value=value+adpcm(dataIn[j],2)
											j++
										}
									}
								}	
								return value
							}))
							data=new Uint8Array([...header(),...data])
							break
						default:
							break

					}
					save(data,file.name,format)
				})
			})	
		}
		function header()
		{
			var identifier=new TextEncoder().encode("defydefy    ")
			var title=new TextEncoder().encode(document.getElementById("title").value.padEnd(50, " "))
			var cover=new TextEncoder().encode(document.getElementById("cover").value)
			var visualizer =document.getElementById("visualization").value
			if (cover.length===0)
			{
				cover =new TextEncoder().encode(
`1133333111331233333051d555131355545313c14444494d113d445151111176df11111515445311d494244d13313555553151555c151333332133111333c311
3313c33111c33555511153b353515315d4431330aa54495a33c3db3111031166761101111bbc5d33d4a5449a03d1344d53d133513b51111555133d3115333133
13533511313335111311113d5553133d53d5313c5999ad3111013cbb111001166111101133c3301135a49956c333dd53d3115555d313110501d5331113153351
30dd5511113d35331513333d3553555553dd3111b9d51311013ccbcbc111111dd1111113bcbcb31101305d9b1111d535553353533333315333353c111155d513
555d55011c1c151dd10351113131553dd5add33d3413311330ccbb33311111111c11111c3bbccc111135d353d133e655d555311515135031d15331111355e555
3454433111111313333310513315d5555d455d110111310333cbbbbb3311111661101133bcbbbc333031310113dd4493555d1533110113c353111c1113154553
3154d53cc11111053d313310d6dd5533349460101311011153b333c3cbc10d6776d01c3c3c333b3331000115011d54435354ddd6031313535113111cc1544453
dd445411c1c133055333113394355d45531bc3cb31d3100b331cd3113b31166ee66113b3013cc33550113333cb3bb33d55d53544531315555003111c115435dd
b5d3333511101315555d354554333335113bbcccc313311535333c3113cc166ed661cc31153330533113313cccccb31153333565345335535331011133335dbd
36bd153d311133533551dd44545531311133bbbbbb3301005133311111b366edee66331311133355000353bbbbbbb311035dd55544ad1555333311c1d511ddd5
5da4a3153d31153131335ddb444651001133b3b331310313351cc31d333366edee663353d13cc113310313131bb33c111303d4454d3d33313131115555364bd5
53355d324551153115554d354456511111c33c33c3333d3c1351bc333dc366eedee6cdd333cb15313dc513d333cb3d11001dd54435bd555131551355d1599bd3
553d4a5455d5dd3335555d3395d661111113c313d3301311113d3c31351dd66ed66d333311bcd31111300333333b31101116664a315455133d55dd5545b53351
225d3354a55355d35551d303576751111113b3111bc05111115dc33d33133c66e7d3c313cdbc351111131cc3111c3c1111117663313d15531355555a44545522
5555544444d35d5d535355311dd66111111cb1111bc335011313cb11103b1127711c330101bc303111133b30110b331111167dd113345355dd55559444555d45
55d55d32433d4453d55553501111d111113c30531bc1d133c311333d13bc3115d1113c315c3c153c333d13c3d31c3c001c1d111113555555554db33553d45d55
bbd65553153335431d535501011c1666d1133333dcbc31331153333313b3111110113b31333333113511cc31330331166d61111000153453354355111539bbbd
666f9f533315335e449511111111167666dc35d5313cc31503533cd3c33c11111211c33c3cc53350311cbb333ddbcd66666111111111d94f4d3333333deef666
6d554ad3d3d353bd44531111111066eee676cc3331133313335333bbcb3111ddd51113bbbb33333d533331135dc3666eee6611101111354ddd31153d349d5dd6
cd2dee5d3333315d553bbb311110d6eded673311111333305331d33cbb3331153513333cc31d053313c3d311113c766ee66d011113cbb35533133333ddfed25d
6d2dee6dd33d3133353c33333111d66eeee6d3b3013dc3335cb1033cc35331554513d33cc3033dc3331c33113b3d66eede6d1111333cc35d3d133d1d6dded2d6
4f4eed66fd51311c13cbcb3bcc3c166dede6c33cb31333311333333cbb333354453333bbcb33333033333113b3cd66eeee61cc3cb3bbcb11313513d666ee4ef4
56efe6ef49d4fd1103cbbbccbcb3d66eeee71d1db3cbb3133333333ccb3bc113111cb33cc3333535313bbcbc3c117edde66c3bbcccbbbc31113f4a4affd64ed5
b545366f44b9493113cb333101333c66e667011c33b3cc3333b333cccb3b31c33313bbbcc333b3b333cc33331111767666d31103033bbc3115a4a454ff6d5e43
d1333d644244a51133cb3c5311313cd3dd7d111113d3ccb333ccb33bcb3bd1111113c33ccbcccb3333cb3d331111d6ddd3c3331133cd3c31115954544add3335
213d3d3a4449433110b3db311335d3c3d1111111133bbccc33bcc3cccb3c313c3311bbbbc333cbc3ccccbb3111111111c33dd3311d3cbb131334a444a3313312
413c35359a5951113d13333315333133c1011d5313333bcb3dcbc33cbbbb13c33cc1cb3cc3ccc333ccbb333135d210113c13353113b1303111054494535c3334
435333c5449533011335d3c3c13d51b31111dd105c3b3bccc33ccc3cb3bc3b3bbbb33b3bc33ccc3cccb3b331053d1113c305311c3c3333311133494a33c3351d
53511333ba533110133531133c33103b31111554333bb3bcc33ccc3cc3bcbb3b333ccb3bcccc33ccbbb3bd35d4351113c31133cbc3155551100314db1c111335
533311511d3111001001313d3bc1113c3c110d44d11cb3bbccc3cc3cbbbcbb3333bbbb3bc33c3c3cb3b3313144d11133b3111333151311111011133313135555
d55d53531c011333111c35d53cb3c13b3133354513113bb3bbc3cc3c33bbbc3113cb3b33cccc3ccb3bc33131d5533133c313dcc33d53c003333111d1d3335555
5444dd33c011035350331111133c33cb3333313331111cbb3bcc3c3c3bbb3101001cbbb333cccbbbbb311113331333333c333331301135003531311c1ddd4455
d33346dd5033b33353311113135dc3bcbb3333113ccb3cccb33c3c333b3c31033003cbb33cc3c333cccbccc3131b333bbbbcc33151111c3533333315b1e433d5
3553544433cccb3515d11113d333333cc33bbc11c33b3bbbbb3333c133bc01111101ccb3131333bbbbbbbb3311cb33ccc333335333111331d3bccc3554433d53
3d5d4943cccb33c3303111c30113c03ccbb5b311bb3bbbbb3bb3011033b3111113301b3303113bb3bbb3333c11cb3bbcc31cb0311c1111153333bccc349d4553
51555d5bbbbb3c33c1d3133103310333ccc3bc33c3b33cccbbb3b033bbc1011c11101cb33333b3bccc333bbb33b33bccb30033301531533333c3bbbbbd5d5355
55335313bcbcb3bdbc331113535d3333bcbb3bb33b3110013ccb3b3333c001111c1103b33333bdb3013113333cb3bccc33313153313153cc3cbcb3bb31531153
455555113b3331113c3c333335cb33333cccb3cc3b331000003cb33b3bc031c11c110cc33333c311000133bbcbb3ccb33333dc333533c3c31501b33c115d5555
45d5d1111c3331111cb3c3d1b103333c33bcb3bbbbc003313001c3330bc011111c1103b335bc300113310ccbcb3bcb3c3b33303d3d3cbb311113c3d111135d55
d5333111313bb1133111333cb3133bcb3ccccb3cbc30111111101c333bc011c111110c3333c10111110003bbbb3ccc3cccb3313b13b31c13311b3331101335dd
53350010111cb10353c113d330333bccc333cb3bbb30031c113003c333b001111c100cb53bc00111c13103bbb3bc33ccbcb333033c311d33301cb31111005335
41d3311111133c0dd330333b333333ccccc3c33bbc31111c1c1103b333b311c11c113b33bb103111c11103cb33cc3cccbc3c3333b351133dd1bb311111113b1d
446dd110111cc3bc511013cbcccc33333ccccc333bc1111c1111113b3b3c00111110cb3b33101c11111113bb3333cc3c3333ccccbc301013333cd111101d6944
55566d1111001533b3bcb3b3cccccc3c33cc3333bbc0031111cc103bbdbb311cc113bb3bb3011111c1111cb353cccc333cccccbcb3cbcb3dcc11011111c66545
444666111d7667663c3cb333bbbbcccccc3ccc3033c3111c1111111cb3cbb11111033c3bc101c111c1103cb303cc3c3cccbcbbb3b33b333cd76767d1116e6545
3446666c6666e6675c313d33333bbbbbbcc33c113bbb1011c111110bb33cb311113bb33bb311111c11013b333333ccccbcb3b33333333cd3f6ee6666d6666445
3356511166eeede6d111111333b3333b33333103333c31011c11c11cb3033c3113cc313cb11c11c1110cc3330113333bb3b33b33c111111d76edee66111dc533
3311111cd6ededee7d011133c3bbbcbbbbb333333333cc0101c1c10bbc133bb11b3c311cb111c111013c33bb333333b3bbbbbb33331110d76eeded6dc1111135
35111110276eeeee6611110533133c3cbbb3b33333333b331011111cc3ccccbccbcbcc3cb111c1101cbb3330333bbbbbc3cc31c151511166eeeee67d11111033
d300111101666e666c11dd34131113bbb3bbcbbbb30333bc3111110bcccbbbb3b3bbcbccb111101bcb33303bbccbbb3bcb311111455411c676ee66101111013d
511110111c16666d011255542311cc33ccc3c3c3ccb333bbbbb3111cbbbbbb333bbbbbbbb11133bbb335bbcc3333cccbb3c31135443d1101d6e661c111111115
51111111cc33dd111101354dd313bbbbb3001010013cb333cc333cbbbbb31cc3cc313b33cccbb3cc33b3c3301010003bcb3bc135553510111cc33dc11111111d
5113c333b33cc3ccc1111135133c3333110131111013bbb3133cbcb33cc33303313d33cb3bbbc3333bbb3000113110133b333331d15111113333c33cc33c1115
53cb333c3113d33b33113331311b3b311031111111101cbc313cbb33331bd311013dc33b3b3cc311cbc101111111110003bbc1131333113cc31c503bb333bc35
4bbb3bc311351303c3313d33311c33b31331111c111103b3c0ccbbcbc31111111111315c3cbbcc1bbb10111c1c11131133333313c335333b303d33103cb3bbb4
5cccbb311133d301333333bcb313b3c30011cc111cc1013bb3cbbb31101111c33311110113b3bc3cb3011c1111cc11013bbc313cb33333c311335d1011cbccc5
433cb3d311d333001cbb3333bcc3cbbb101111111111c103bccb33d31133d1135113330133dbbcbb3111111111c11101cbb33cbbb33b3bc1115353113bbbbc35
31ccb3cb33ccc12333cc3b333bbbcbbc301111c111111111cbbbb33c1133531333153311333bb3bc11111111c1111013b3ccbb33333ccb33311ccc33cc33bc13
11bbc3c3cc33b33c3bbbcccbb33bbbcbc300111cc1ccc1103b33c1311d33331c31c3d1c1131c33b301ccccc11111103cbbbbb3bbbccccb3d31bbb3c3531bc301
1113cb053313cc33c313ccccccb33bbbbc310111111011113c3bc11111113111111331311133c3c311010111111103cbbb33bcccccbb333333cc1133d3cc3313
101303d31013113313313bbcbcccb33bbbcb30000000033bbb3bd303d13111111111111c311cb3bbb33100001011ccbbb33ccbcbb3331333c133511113333501
5113333333531153bc03333333bccc30333ccc3333cbbbccc3bc301333c11111111113335103cbbccbb3bc33ccccb33333bcc3c33c33103c3111533333331115
53115501d1015331130333cccc3333c330b33bbccbbbcc3bcbb3131d3331131cc1311d33d1133bbc3ccbbbb333333b0333c33333c33331333533010d10551113
101001303111131353d333bbccccccc330333333bbc3311cbb3c31113d3111ccbc1113311113d3bcc01c3b3b333b33033ccccccccbc33d353033111335100131
33301150c1111315b3d33ccccccccc33113b333133bc311cb3bb3311113111cbcc0111cd1133cbbbc013ccb333333303cccccccccbcb3d3530c1111c01110131
50113300c111335111333bbb33331cc3133333bbbbbbbcbcb3c3111c3c31131cc1311333c1133b3ccbcbbbb3bb333b3031133333bb3313313353111c00330015
5111533353151133b3003333c3ccc3313b3bbc333c3bbbbccbbc311353c11101101113533111cbbbbbbbcb3c3ccb333333cccc33333310bb3111111335533115
30331353011313133b31333ccccbb3bbbbcc11110011133bbb3cb113c13111133311131d311c333bcbc101000103cbbbb3b3cccccc3313c13313530533313311
1110bb133313cc33c333ccccbcb333b3bb30100111111113dc3b311111113111111311c1110bb3c310000111110103c33b33bbcccccc333c33cc313353b33101
303cb3c3cc333333d33ccbccbb3bbcbbbc1011111c1111103b33c1311133d313311333c1131c33b3111c11c11111013bbbbb33bbcbcbc33333b333c33c1bc311
30ccb53b53bc311353bbbcbb33bcbcbc3011111c1111c111cb3bb3331133131c531c3d11335bb3cc011c1111c1111113cbccbb33bbcbcb335113cb33c33bcc13
d1cbbbc3511d3d111cc3333bbbc3bbbb10111c11111c1113bcb3b3cc11d3d31333c53311d33b3cbb3111111111c11101cbbc3cbb333b3bc011331c113dbbbc15
4cbb3c3101c3c3013b3b333bb313c3c310311c1111c1111bbcccb331111111c3d311111113d3bcbcb311cc1111c113013bbb333bbb333333115c3d1113cbcbb5
4bccbb3501335301bb313b3c11133bb11011c11ccc1111b3c3bcbbcc3303111111111033ccbbcc3cbb1011ccc1c11103133b3111c33333bc3035331133b3cbbd
93bb33bcb115d13bc3d11d31311cbb311031111111111cbc311ccbbbb31c3311113cd1c3b3bcc301cbc10011111111130b33c3111355113bb355d103cb3bbb34
d013c333bb33cbc3d11111513c3b3b33300111111001bbb3013bbb333cc33d11313c33c333bbcc333bbb1001111110013cb3b3135313111d33c333bbb33c1115
5111111cccc3dd331111d3545113c3b3c3100101013cb333cb33ccc33bb3333333303bbbbccbbbbc3333cc1011010133b3b3c131d4151111c16dc36c11131d15
531111111156766d1011535453113b3bbb3c3133cccb33bbbbcb333bbbb3bcbcbcbbbb33b13133bbbb3bbbc331133cbcb3c33115443d1011d666633111111115
53100111017666676d11d55d511113dcbbbbcccbcb33333bc310101ccccbb3b333b3cbccc1110033c333133cccccbbbbbc311115d53411d66666671111111033
c10111115776deee66112503133333cbcbbbbb3333333bc30111110bbbcccbbdcbbcccbcb11111103bb33333bbbbbbccb333313330521166eeeee67d1111111d
33111111d6deeed67d0111333cbcbcbbbb3333333b03b300011cc11cc313cbc33bbc313bb11c1c1011cb33b3303333bbbccbbbc3311100d76ddede6d11111133
33dc311176eedee6d1111113b3b3b3b333333003333cc1111c11110bb313bb3103bb313cb10111111003c335303533b3bb3b3b3335111116eeeeee661111dd33
5446e6cc66e6ed6ecc111c133533b3bcccc33c3053bc00111101111cb33cb3111133c33bb111111c1111cb3303333ccccb3b3333333dcc1d66eed666dd666d45
245666211d766e6d333c3333bbbcbcccbc3ccc30b3b3031c111c111bbccbb111111bbc3bc311c11111103b3303ccc33bccccbb3b3333333cd66667d11c666545
454d7d11110113c3c33cbbb3ccccccbc3cccc33333c10311111c103cb3bb311c1113bb3bb3011111c1110cbb53c3ccc33bbccccc3bdbcb3c3331111111de6545
454dd1111111c333d31131cbcbcbb3333cc3c333bb3001111cc1113b33bc01111c00c333bc111c11111103b333c3ccccc3c3ccccbcc01033dc3c1111111dd445
43d5311111133313d331133b333333cccc3ccc333bc111cc1c1101c333b101c11c103b333c0011c1c1110cbbb3c3c3cc33333b3bb3311355d133c1111111d535
53330011111cc31353d1133331333ccb3c33c33bbb301111111103cb33c1011111101cb33b301111c11103cbb0bcc1ccccc33303333113d3303b311111113135
dd5351011113b01335110bc3b1133bccc33ccbbb3bc0011c11111c333bc011c11c110cb333c11011111113b3b3bcc333bbb3313c3cd31333d01cbc1110013536
54d5d1111c3330121ccbcbd1c31333bb33ccb3bcbbc013111111cb333bc011111111033333bc1111111103cbbb3bc3c3ccb3110b133b3c31111333c11113dd45
45355311c33c33113b3c3333333333c33cccb3bbb3c00001101bc333333011c11c110c33b33cc301111033bbcb3bccc33333bc53353cc3bc1131c33311d55355
55353313bb3b33d3cc331115355c15333ccbbbcccbb331011ccc33333bc0011c1c110cb3333bbc311010333c3cb3bcc33331d333531133cc3cb3b3bb3133d555
515554d3bcbb3c3bc35513d103510133ccbb3b30b3b333cbcbbbb03333c1111c11010cb30303bbbcc3c33b3b33bb3bcc3301035013155d1333c3bbcbc5e51155
3355d443cccb33d3113311c3133bb13cccb3bc11c333bbbb3bb301303bc30111c1101b3303113bbbbbbbb33c11cb3bccc31bc3533c111313d313bccbd4454533
55555a453bccb33353d1111b5131333cbb3bb311bb3b33bcbb3333313bb3101111113cb3533333bbbb3333b3113b3bbbc33333113111135133cbcc3d55933553
5533dd563133b333d0d11113135cc3bcb33333113c3cdcccb333ccc333bc30111001cbb33cc33333cccbccc3313c333bcbbd335351111c33333bcb03d3ed3555
5d4d5d533115155310331111033333cb333c513351131bbbb3c3c3c33bbbc100111cbbb333ccccb3bb3131133113333b3c333331111111015d51111333dd44d5
d54533d513113333501c31d33cc333cb333331d133113cb33cc3ccc333bbbb30333bbb33cccc3cb33bc31131d5533333bc33dcc33353c11333330131533d5455
5333531113011111110131153b3150533d110444111bbbbbcb3ccc3cb3bc3bc30bb3bb3bc33c3cccbbbb31115440115331011b33551310110001133131133353
53d11333cad510010333113c3c31113b3113334e31cb333cccc3c33cc3bcbb3bb33bcb3bc3cc31cbc33bbc35d4331113b3111ccbc1153330111154ac3c315555
43333dc5649d3310335533c3c33d30b3c112dd30333b3bcbb33ccc1cbbbcbb3333cbcb3cc3cccc3cccb3b33113561113c313c3133c3355330333d9445d33333d
413333344959511135033333133331c331011dd133333bccc3cc333ccbbc13cb3bc0cbbcc33c3c33ccb333c335d5001c3c1553313333305311154494b331d134
513d555a444a531131bc3cd11c5dd33dc10110113333cccb33cbcc3ccbb3313bc313bb3bc33cc333bccb3351111111113b3d533113dc3b1111349444a5d33311
5133dc644445941111bb333301333c35dd66101115b3bcc333cbc33cbb33c1131113b33cc333bcb33cccb3331001d7ddd3c33311d3c33c311149445446dc3355
3ddd56fa44494a3013cb3b1111013d7667e711113333ccb33bbb333ccb3b3133331cc3bbc3ccbcb333cbb3331110766666d31111133bbc3113a4a544ff63dd5d
3f9a666f4a54a30313ccbcc3bbb3c666ee6701c3bcbcb311333333cccb3bc111511bb33ccb333333113bcb3b3dc17eee676c3bbc3cb3bc30105a4aa4f6669ee5
4eeedef66b3333d310bcbbbbc3cd376ede66c13bc313b3b10313333cbb3333d54d3333bcc33333101b33c13cc33166eee6613c3bb3bbc313333331d6f6eeedf4
6d5d8edd65333115d3cbb333d331176edeeed3c31033c13b36b1113ccb3b31542513d3bbcb110dc333c3b311333d66edee7d1c1d33bbcbdd3113335bdde8e5d6
6d2ddedd3135313c343bccc11111d6eeee66c310111d33315331333bc33513335313333cc33303333333310103cd7eeedd6d01111ccbcb533d1333d3d5fd25dd
6555ee4133c131dd44210031111066dede66c35331133d335353c33bb3351156651113bbb313333d533135133533666ede66011111113444dc1d3c333d94ddd6
66df4e43c53333ddf44531111111176e66cd3dd33d3cc30d03133d33cb3d11111111333c3bc33551511cc3333dd3cd66e67111111111144dd553113d1deeed6d
cdb65d5331315d4515d53110111116666113333d33bc3033133533c313b3110110113c313d3c35313313cbc1d31333166661111101135d435d5335331554dbdd
bdd53b552535d423d5555d301111c11101c3b13d1c33d353cd13333d13c3c105d0113b313c331533351533c3331b3c11111c1111135555555545515515653ddb
55d54544445555553535530011c76111111cb11113cd31111311cc11113b1157751cc31111bc10311135d331111cb11011166cd111355355d345d34444354d55
22555544945355333553d533d76711111113c1111cc331110135333d313bc16666d33353d1bc3d1111131cc3110cb111111d6e63311d553335d535444454d554
033544b45d544db555454d3544d661111133b313b3300511015dcc333513d67eee6d335331bc551111111333303b3c1111166dd4d334554555b45d55ab543311
15d4a53455333d5c33155d314d46d11111c33c3c33353c3c1551bb333dcb66eee666ccd131cc33313c331333c3cb3111011ddd4453dd5333333d355555499351
4db5a3145351130111535ddd444d110011133bb131330103311cb31d353366edee663333c13b3113311133133bb333111111d445dd55551111501335513b5d65
3da5313dd31133d35553da5435553131113bbcbb3c35110131333111113366eded663310111c3115101053bb3bbcb3110313d54544a335555333113dd351abd5
d3d33555311013135553355544333d351133ccbcc3333030533333c103bc166ee6edc331013333331113313ccccc331153d3334553d315535131011355311d3d
db455531c1c1300553d13333443d5551d133c3cb3053011b531cc310bc31166ed6e113cb31bdd33530131d33bcbbb51d15d1d1d453031d315113111c13d4546b
3545d533c111111533311111ad655553d44563103311001333b133c3cbd11d6776d113cb3c333c3530001111010c54d535545da403151335511011cc11545513
1454431111111355333311313355d5555d954d311011311531cb3bb333110116611111333cb3bc333150110013b444d55d5d5333311333c35331c111135d4445
d554451111c31315d51311113313553d43ad33335333311033ccb3b33c111111c111111d3bbbcc35110b3c35d353a654d355313315313153353131111355d355
33dd551111c13533330b33535553515553dd5511d94d5311013cccbc3110111dd1111113bbccb31003c5494b1111dd535353352dd303303115353c1111545553
1553331111c333515113103c555113335dd3113ca4994f5111033bbc1110111661111111cbc3310114494a4ac533dd53533153553313305551d3331c11353331
3313333111c35555011033db15333355d45313314949594a35356bc011111166661110111bc6353564a4444413113d4d55311553dc53111153533c1101333113
1133c351113311133b1151d3551511d3445353c34a55595d113d54531111116dd61111111545b311c49544a53c333545553133155315013b3121331113c33311`)
			}
			var index=0
			var hiNibble
			var coverData =new Uint8Array(Array.from({ length: 8192}, (_, i) =>
			{
				hiNibble=false
				value=0
				while (true)
				{
					if (index>=cover.length) return value
					var character=cover[index]
					
					if (character>=48 && character<=57)
					{
						if (hiNibble)
						{
							value=value+(character-48)*16
							index++
							return value
						}	
						else
						{
							value=character-48
							hiNibble= !hiNibble
						}
					}
					else
					{
						if (character>=97 && character<=102)
						{

							if (hiNibble)
							{
								value=value+(character-87)*16
								index++
								return value
							}	
							else
							{
								value=character-87
								hiNibble= !hiNibble
							}
						}
					}
					index++
				}
			}))
			
			return new Uint8Array([...identifier,format,visualizer,...title,...coverData])
		}	  
		fileReader.readAsArrayBuffer(file)
		spinner.classList.add("d-none")
	}
	
	function save(data,filename,format) 
	{
		var file = new Blob([data])
		var link = document.createElement('a')
		link.href = URL.createObjectURL(file)
		switch (format) 
		{
			case 0:
				link.download = `defiance_${filename.split(".")[0]}.pcm`
				break
			case 1:	
				link.download = `defiance_${filename.split(".")[0]}_lossless.defy`
				break
			case 2: 
				link.download = `defiance_${filename.split(".")[0]}_lossy4.defy`
				break
			case 3: 
				link.download = `defiance_${filename.split(".")[0]}_lossy3.defy`
				break	
			case 4: 
				link.download = `defiance_${filename.split(".")[0]}_lossy2.defy`
				break	
			case 4: 
				link.download = `defiance_${filename.split(".")[0]}_lossy1.defy`
				break					
		}		
		link.click()
	}
</script>
</body>
</html>	
